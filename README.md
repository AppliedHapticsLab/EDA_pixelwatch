# Pixel Watch EDA Logger

Pixel Watch 2 のcEDAセンサーを使用して，皮膚電気活動（EDA）を計測・表示・記録するためのアプリケーションです．
計測データはCSV形式で保存され，ペアリングされたスマートフォンへ転送されるようになっています．

## 概要

Pixel Watchに搭載されている特定のセンサーID (`65554`) を利用することでEDAデータを取得できるようになっています．
参考となるサイトは以下のサイトです．こちらのサイトはPixel watch 2に内蔵されているセンサの詳細とアクセスをするためのIDを調査したものになります．
Pixel watchに内蔵されているAFE4500と呼ばれるものがcEDA用のセンサICとなっており，出力されるデータがどの様なものであるかも記述されている便利なサイトです．
URL：https://smart-health.pages.cs.hs-rm.de/activesense/sensor/sensor_db/

> [!WARNING]
> **本サイトを参考にデータを単位変換しています．本来の単位とはずれている可能性もあるので単位は目安程度としていただければと思います．**

基本的には以下の機能が使用できるようになっています：

* **リアルタイム表示**: EDA値（µS: マイクロジーメンス）と生の抵抗値（mΩ）を画面に表示．
* **データロギング**: 計測データをローカルストレージ内のCSVファイルに記録．
* **データ転送**:
    * 計測終了時，保存されたCSVファイルをペアリングされたスマートフォンへ転送 (ChannelClient)．
    * 計測中，リアルタイム値をスマートフォンへ送信 (MessageClient)．
* **リモート制御**: スマートフォン側からの開始/停止コマンド (`/start_recording`， `/stop_recording`) を受信可能．

## 動作環境

* **ハードウェア**: Google Pixel Watch 2 または Pixel Watch 3 (cEDAセンサー搭載モデル)
* **OS**: Wear OS 4.0以上推奨
* **開発環境**: Android Studio Koala Feature Drop | 2024.1.2 以降

## セットアップとインストール

1.  このリポジトリをクローンまたはダウンロード
2.  Android StudioでプロジェクトをOpen
3.  Pixel Watchを開発者モードにし，ADBデバッグを有効にしてPCと接続（充電ケーブルをつなぐと有線接続での通信も可能となります）
4.  `app` モジュールをビルドし，ウォッチにインストール

## 使用方法

1.  **権限の許可**: 初回起動時，ボディセンサー (`BODY_SENSORS`) へのアクセス権限が求められた際には，「許可」を選択してください．
2.  **計測開始**: 画面上の "Start" ボタンをタップする，もしくは別アプリのスマートフォンで操作します．
    * 画面には現在のEDA値が表示され，記録中はステータスが "RECORDING" になります．
    * 計測中はWakeLockにより画面およびCPUがアクティブな状態を維持します．
3.  **計測終了**: "Stop" ボタンをタップします．
    * データがCSVファイルとして保存されます．
    * ペアリングされたスマートフォンが見つかった場合，自動的にCSVファイルの転送を試みます．

## 出力データ形式

保存されるCSVファイル (`EDA_yyyyMMdd_HHmmss.csv`) のフォーマットは以下の通りです．

| カラム名 | 説明 |
| --- | --- |
| `SessionStartTime` | セッション開始時の日時文字列 |
| `Timestamp_ms` | システム時刻 (ミリ秒) |
| `Raw_mOhms` | センサーから取得した生の抵抗値 (mΩ) |
| `Converted_uS` | コンダクタンスに変換されたEDA値 (µS) |

**計算式:**
`Converted_uS = 1,000,000,000 / Raw_mOhms`
> [!WARNING]
> **本サイトを参考にデータを単位変換しています．本来の単位とはずれている可能性もあるので単位は目安程度としていただければと思います．**

## 通信機能について

このアプリは `Wearable.getChannelClient` および `Wearable.getMessageClient` を使用してスマートフォンと通信します．
ファイル転送およびリアルタイム通信を正常に行うには，ペアリングされたスマートフォン側に，以下のパスを購読する別アプリケーションが必要です．

* **CSVファイル受信**: Channel ID `/eda_csv`
* **リアルタイムデータ受信**: Message Path `/realtime_eda`
* **リモート開始コマンド送信**: Message Path `/start_recording`
* **リモート停止コマンド送信**: Message Path `/stop_recording`

※ スマートフォンアプリが存在しない場合でも，ウォッチ単体での計測とCSV保存は可能です．この場合は，Android Studioよりストレージにアクセスする必要があります．

## 注意事項

* **センサーID**: 本アプリはセンサータイプ `65554` をハードコードして使用しています．これはPixel Watch等の特定デバイスにおけるEDAセンサーのIDであり，他のWear OSデバイスでは動作しない可能性があります．
* **バッテリー消費**: 計測中はWakeLockを取得し続けるため，バッテリー消費が早くなることに注意してください．
